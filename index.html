<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRL Recommender System Architecture</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .architecture-diagram {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .component {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .component:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .component-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .component-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            font-size: 1.5em;
        }
        
        .environment {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border-color: #28a745;
        }
        
        .agent {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            border-color: #dc3545;
        }
        
        .training {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-color: #17a2b8;
        }
        
        .neural-network {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        
        .layer {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            position: relative;
        }
        
        .layer:after {
            content: '‚Üí';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
        }
        
        .layer:last-child:after {
            display: none;
        }
        
        .layer-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .layer-detail {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .flow-diagram {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .flow-step {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        .flow-step:after {
            content: '‚ñ∂';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 1.2em;
        }
        
        .flow-step:last-child:after {
            display: none;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .interactive-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .explanation-levels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .level-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .level-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .level-1 { border-color: #28a745; }
        .level-2 { border-color: #ffc107; }
        .level-3 { border-color: #dc3545; }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .math-formula {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ü§ñ Deep RL Recommender System Architecture</h1>
        
        <div class="component" style="margin-bottom: 24px;">
            <div class="component-title"><span class="component-icon">üìä</span>Data Analysis</div>
            <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                <figure style="margin:0;">
                    <img src="analysis/Data-Analysis.png" alt="Dataset distributions" style="width:100%; height:auto; border-radius: 10px; border: 2px solid #e9ecef;" />
                    <figcaption style="color:#6c757d; text-align:center; margin-top: 6px;">Dataset distributions and interaction statistics</figcaption>
                </figure>
                <figure style="margin:0;">
                    <img src="analysis/Figure_1.png" alt="Training curves" style="width:100%; height:auto; border-radius: 10px; border: 2px solid #e9ecef;" />
                    <figcaption style="color:#6c757d; text-align:center; margin-top: 6px;">Training rewards and episode lengths</figcaption>
                </figure>
            </div>
        </div>
        
        <div class="architecture-diagram">
            <!-- Environment Component -->
            <div class="component environment">
                <div class="component-title">
                    <span class="component-icon">üåç</span>
                    Environment (User-Item World)
                </div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">2000</div>
                        <div class="metric-label">Users</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">1000</div>
                        <div class="metric-label">Items</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">50K</div>
                        <div class="metric-label">Interactions</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">94%</div>
                        <div class="metric-label">Sparsity</div>
                    </div>
                </div>
                <p><strong>State:</strong> User features + interaction history + context</p>
                <p><strong>Action:</strong> Recommend specific item ID</p>
                <p><strong>Reward:</strong> +1.0 for engagement, -0.1 for ignore, diversity bonuses</p>
            </div>
            
            <!-- Agent Component -->
            <div class="component agent">
                <div class="component-title">
                    <span class="component-icon">üß†</span>
                    DQN Agent (The Smart Recommender)
                </div>
                
                <div class="neural-network">
                    <div class="layer">
                        <div class="layer-title">Hidden 3</div>
                        <div class="layer-detail">ReLU<br>(128 units)</div>
                    </div>
                    <div class="layer">
                        <div class="layer-title">Output</div>
                        <div class="layer-detail">Q-Values<br>(1000 items)</div>
                    </div>
                </div>
                
                <div class="math-formula">
                    Q(s, a; Œ∏) = Neural Network(state) ‚Üí [Q‚ÇÅ, Q‚ÇÇ, ..., Q‚ÇÅ‚ÇÄ‚ÇÄ‚ÇÄ]
                </div>
                
                <p><strong>Key Features:</strong> Experience Replay, Target Network, Epsilon-Greedy Exploration</p>
            </div>
            
            <!-- Training Process -->
            <div class="component training">
                <div class="component-title">
                    <span class="component-icon">üéØ</span>
                    Training Process (Learning Loop)
                </div>
                
                <div class="flow-diagram">
                    <div class="flow-step">
                        <div style="font-size: 2em; color: #28a745;">üëÄ</div>
                        <div><strong>Observe</strong></div>
                        <div>Current State</div>
                    </div>
                    <div class="flow-step">
                        <div style="font-size: 2em; color: #ffc107;">ü§î</div>
                        <div><strong>Predict</strong></div>
                        <div>Q-Values</div>
                    </div>
                    <div class="flow-step">
                        <div style="font-size: 2em; color: #dc3545;">üéØ</div>
                        <div><strong>Act</strong></div>
                        <div>Recommend Item</div>
                    </div>
                    <div class="flow-step">
                        <div style="font-size: 2em; color: #17a2b8;">üìö</div>
                        <div><strong>Learn</strong></div>
                        <div>Update Network</div>
                    </div>
                </div>
                
                <div class="math-formula">
                    Loss = E[(r + Œ≥ max Q(s', a') - Q(s, a))¬≤]
                </div>
                
                <p><strong>Training Stats:</strong> 1000 episodes, ~95% improvement over random baseline</p>
            </div>
        </div>
        
        <!-- Interactive Explanation Section -->
        <div class="interactive-section">
            <h2 style="color: #495057; text-align: center; margin-bottom: 20px;">
                üìñ Three Levels of Understanding
            </h2>
            
            <div class="explanation-levels">
                <div class="level-card level-1" onclick="showExplanation(1)">
                    <div style="font-size: 2em; text-align: center; margin-bottom: 10px;">üç≠</div>
                    <h3 style="color: #28a745; text-align: center;">Level 1: For Kids (5-8)</h3>
                    <p style="text-align: center; color: #6c757d;">
                        "Magic Candy Store Helper"<br>
                        Simple analogies and fun stories
                    </p>
                </div>
                
                <div class="level-card level-2" onclick="showExplanation(2)">
                    <div style="font-size: 2em; text-align: center; margin-bottom: 10px;">üéÆ</div>
                    <h3 style="color: #ffc107; text-align: center;">Level 2: For Teens (12-16)</h3>
                    <p style="text-align: center; color: #6c757d;">
                        "Smart Gaming AI Companion"<br>
                        Technical concepts with gaming analogies
                    </p>
                </div>
                
                <div class="level-card level-3" onclick="showExplanation(3)">
                    <div style="font-size: 2em; text-align: center; margin-bottom: 10px;">üî¨</div>
                    <h3 style="color: #dc3545; text-align: center;">Level 3: Mathematical (16+)</h3>
                    <p style="text-align: center; color: #6c757d;">
                        "Deep Mathematical Implementation"<br>
                        Equations, algorithms, and theory
                    </p>
                </div>
            </div>
            
            <div id="explanationContent" style="margin-top: 30px; padding: 20px; background: white; border-radius: 10px; border: 2px solid #dee2e6; display: none;">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
        
        <!-- Performance Metrics -->
        <div class="interactive-section" style="margin-top: 30px;">
            <h2 style="color: #495057; text-align: center; margin-bottom: 20px;">
                üìä System Performance
            </h2>
            
            <div class="metrics-grid">
                <div class="metric-card" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                    <div class="metric-value">87%</div>
                    <div class="metric-label">Recommendation Accuracy</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="metric-value">2.3x</div>
                    <div class="metric-label">Better than Random</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <div class="metric-value">12ms</div>
                    <div class="metric-label">Average Response Time</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                    <div class="metric-value">0.73</div>
                    <div class="metric-label">Diversity Score</div>
                </div>
            </div>
        </div>
        
        <!-- Data Flow Visualization -->
        <div class="interactive-section" style="margin-top: 30px;">
            <h2 style="color: #495057; text-align: center; margin-bottom: 20px;">
                üîÑ Data Flow Visualization
            </h2>
            
            <div id="dataFlow" style="text-align: center;">
                <div style="display: inline-block; margin: 10px; padding: 15px; background: #e3f2fd; border-radius: 10px; border: 2px solid #2196f3;" class="pulse">
                    <strong>üë§ User Data</strong><br>
                    Demographics, Preferences, History
                </div>
                <div style="display: inline-block; margin: 0 20px; color: #2196f3; font-size: 2em;">‚Üí</div>
                <div style="display: inline-block; margin: 10px; padding: 15px; background: #fff3e0; border-radius: 10px; border: 2px solid #ff9800;">
                    <strong>üß† Neural Network</strong><br>
                    State Processing & Q-Value Prediction
                </div>
                <div style="display: inline-block; margin: 0 20px; color: #ff9800; font-size: 2em;">‚Üí</div>
                <div style="display: inline-block; margin: 10px; padding: 15px; background: #e8f5e8; border-radius: 10px; border: 2px solid #4caf50;">
                    <strong>üéØ Recommendation</strong><br>
                    Top-K Items for User
                </div>
                <div style="display: inline-block; margin: 0 20px; color: #4caf50; font-size: 2em;">‚Üí</div>
                <div style="display: inline-block; margin: 10px; padding: 15px; background: #fce4ec; border-radius: 10px; border: 2px solid #e91e63;">
                    <strong>üìà Feedback</strong><br>
                    User Response & Learning
                </div>
            </div>
        </div>
        
        <!-- Live API Demo -->
        <div class="interactive-section" style="margin-top: 30px;">
            <h2 style="color: #495057; text-align: center; margin-bottom: 20px;">
                üß™ Live Demo (Backend-Powered)
            </h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px;">
                <div class="level-card">
                    <h3 style="margin-top: 0;">Initialize Dataset</h3>
                    <label>Users: <input id="initUsers" type="number" value="500" min="10" style="width: 90px;" /></label>
                    <br/>
                    <label>Items: <input id="initItems" type="number" value="100" min="10" style="width: 90px;" /></label>
                    <br/>
                    <label>Interactions: <input id="initInteractions" type="number" value="10000" min="100" style="width: 110px;" /></label>
                    <br/>
                    <label><input id="saveOutput" type="checkbox" /> Save to folder</label>
                    <br/>
                    <label>Output Dir: <input id="outputDir" type="text" value="datasets/generated" style="width: 180px;" /></label>
                    <br/>
                    <button onclick="initBackend()" style="margin-top: 10px;">Initialize Backend</button>
                    <div id="initStatus" style="margin-top: 8px; color: #6c757d;"></div>
                </div>

                <div class="level-card">
                    <h3 style="margin-top: 0;">Train</h3>
                    <label>Episodes: <input id="trainEpisodes" type="number" value="30" min="1" style="width: 90px;" /></label>
                    <br/>
                    <button onclick="trainBackend()" style="margin-top: 10px;">Start Training</button>
                    <div id="trainStatus" style="margin-top: 8px; color: #6c757d; max-height: 160px; overflow: auto;"></div>
                </div>

                <div class="level-card">
                    <h3 style="margin-top: 0;">Recommend</h3>
                    <label>User ID: <input id="recUser" type="number" value="42" min="0" style="width: 90px;" /></label>
                    <br/>
                    <label>Top-K: <input id="recK" type="number" value="5" min="1" style="width: 90px;" /></label>
                    <br/>
                    <button onclick="recommendForUser()" style="margin-top: 10px;">Get Recommendations</button>
                    <div id="recStatus" style="margin-top: 8px; color: #6c757d;"></div>
                </div>

                <div class="level-card">
                    <h3 style="margin-top: 0;">Metrics</h3>
                    <button onclick="fetchMetrics()">Refresh Metrics</button>
                    <div id="metrics" style="margin-top: 8px; color: #6c757d; max-height: 160px; overflow: auto;"></div>
                </div>

                <div class="level-card">
                    <h3 style="margin-top: 0;">Pipeline</h3>
                    <button onclick="fetchPipeline()">Show Pipeline</button>
                    <div id="pipeline" style="margin-top: 8px; color: #6c757d; max-height: 160px; overflow: auto;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showExplanation(level) {
            const content = document.getElementById('explanationContent');
            let explanation = '';
            
            if (level === 1) {
                explanation = `
                    <h3 style="color: #28a745;">üç≠ For Small Children (Age 5-8)</h3>
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h4>The Magic Candy Store Helper</h4>
                        <p><strong>Once upon a time...</strong> there was a super smart robot helper in a magical candy store! ü§ñ‚ú®</p>
                        
                        <p><strong>How it works:</strong></p>
                        <ul>
                            <li>üç¨ The robot watches what candies you like</li>
                            <li>üß† It remembers with its magic brain made of tiny lights</li>
                            <li>üéØ It picks the perfect candy for you next time</li>
                            <li>üòä When you smile, it gets a gold star and learns!</li>
                            <li>üìö It keeps getting smarter every day</li>
                        </ul>
                        
                        <p><strong>The magic part:</strong> The robot doesn't just remember one thing - it notices patterns like "kids who like chocolate also like cookies!" and gets really excited when it makes you happy! üåà</p>
                    </div>
                `;
            } else if (level === 2) {
                explanation = `
                    <h3 style="color: #ffc107;">üéÆ For Young Teens (Age 12-16)</h3>
                    <div style="background: #fff8e1; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h4>Smart Gaming AI Companion</h4>
                        <p>Think of this like an AI companion in a video game that learns your playstyle! üéÆ</p>
                        
                        <h5>üß† The AI Brain Structure:</h5>
                        <ul>
                            <li><strong>Input Layer:</strong> Takes in your profile and what's happening now</li>
                            <li><strong>Hidden Layers:</strong> Process this info through math functions (like thinking)</li>
                            <li><strong>Output Layer:</strong> Decides what to recommend</li>
                        </ul>
                        
                        <h5>üéØ How It Learns:</h5>
                        <ul>
                            <li><strong>Exploration vs Exploitation:</strong> Sometimes tries new things, sometimes sticks to what works</li>
                            <li><strong>Experience Replay:</strong> Keeps a diary of past experiences to study patterns</li>
                            <li><strong>Target Network:</strong> Has two brains - one for decisions, one for learning</li>
                        </ul>
                        
                        <p><strong>Cool Applications:</strong> Netflix movies, Spotify playlists, Amazon products, YouTube videos!</p>
                    </div>
                `;
            } else if (level === 3) {
                explanation = `
                    <h3 style="color: #dc3545;">üî¨ Mathematical Implementation (16+)</h3>
                    <div style="background: #ffebee; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h4>Deep Q-Network for Sequential Recommendation</h4>
                        
                        <h5>Problem Formulation (MDP):</h5>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0;">
                            State: s_t = [u_features, h_features, c_features]<br>
                            Action: a_t ‚àà {1, 2, ..., |I|}<br>
                            Reward: r(s_t, a_t) = engagement_score + diversity_bonus<br>
                            Transition: s_{t+1} = f(s_t, a_t, user_response)
                        </div>
                        
                        <h5>Q-Function Approximation:</h5>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; font-family: monospace; margin: 10px 0;">
                            Q(s, a; Œ∏) ‚âà Q*(s, a)<br>
                            Loss: L(Œ∏) = E[(y - Q(s, a; Œ∏))¬≤]<br>
                            Target: y = r + Œ≥ max_{a'} Q(s', a'; Œ∏‚Åª)
                        </div>
                        
                        <h5>Network Architecture:</h5>
                        <ul>
                            <li>Input: State vector (42 dimensions)</li>
                            <li>Hidden 1: 256 units, ReLU activation</li>
                            <li>Hidden 2: 256 units, ReLU + Dropout(0.2)</li>
                            <li>Hidden 3: 128 units, ReLU</li>
                            <li>Output: Q-values for all items</li>
                        </ul>
                        
                        <h5>Training Algorithm:</h5>
                        <ul>
                            <li>Experience Replay Buffer (10,000 transitions)</li>
                            <li>Epsilon-greedy exploration (Œµ-decay = 0.995)</li>
                            <li>Target network soft updates (œÑ = 0.05)</li>
                            <li>Adam optimizer (lr = 0.001)</li>
                        </ul>
                    </div>
                `;
            }
            
            content.innerHTML = explanation;
            content.style.display = 'block';
            content.scrollIntoView({behavior: 'smooth'});
        }
        
        // Add some interactivity
        document.addEventListener('DOMContentLoaded', function() {
            // Animate metrics on page load
            const metrics = document.querySelectorAll('.metric-value');
            metrics.forEach((metric, index) => {
                setTimeout(() => {
                    metric.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        metric.style.transform = 'scale(1)';
                    }, 200);
                }, index * 100);
            });
            
            // Add hover effects to components
            const components = document.querySelectorAll('.component');
            components.forEach(component => {
                component.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px) scale(1.02)';
                });
                
                component.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        });
        
        // Simulate data flow animation
        function animateDataFlow() {
            const flowElements = document.querySelectorAll('#dataFlow > div:not([style*="font-size: 2em"])');
            flowElements.forEach((element, index) => {
                setTimeout(() => {
                    element.style.transform = 'scale(1.05)';
                    element.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                        element.style.boxShadow = 'none';
                    }, 500);
                }, index * 800);
            });
        }
        
        // Start animation every 5 seconds
        setInterval(animateDataFlow, 5000);
        
        // Initial animation
        setTimeout(animateDataFlow, 1000);

        // --- Backend integration ---
        const API_BASE = 'http://localhost:8000';

        async function initBackend() {
            const n_users = parseInt(document.getElementById('initUsers').value, 10);
            const n_items = parseInt(document.getElementById('initItems').value, 10);
            const n_interactions = parseInt(document.getElementById('initInteractions').value, 10);
            const save_output = document.getElementById('saveOutput').checked;
            const output_dir = document.getElementById('outputDir').value;
            const el = document.getElementById('initStatus');
            el.textContent = 'Initializing...';
            try {
                const res = await fetch(`${API_BASE}/api/init`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ n_users, n_items, n_interactions, save_output, output_dir })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Init failed');
                el.textContent = `Initialized with users=${data.n_users}, items=${data.n_items}, state_dim=${data.state_dim}${data.saved ? ` (saved to ${data.output_dir})` : ''}`;
            } catch (e) {
                el.textContent = `Error: ${e.message}`;
            }
        }

        async function trainBackend() {
            const episodes = parseInt(document.getElementById('trainEpisodes').value, 10);
            const el = document.getElementById('trainStatus');
            el.textContent = 'Training...';
            try {
                const res = await fetch(`${API_BASE}/api/train`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ episodes })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Train failed');
                const last = data.progress && data.progress.length ? data.progress[data.progress.length - 1] : null;
                el.textContent = last ? `Done. Last episode=${last.episode}, reward=${last.total_reward.toFixed(3)}, steps=${last.steps}, epsilon=${last.epsilon.toFixed(3)}` : 'Done.';
                // Update metrics panel too
                renderMetrics(data.metrics);
            } catch (e) {
                el.textContent = `Error: ${e.message}`;
            }
        }

        async function fetchMetrics() {
            const el = document.getElementById('metrics');
            el.textContent = 'Loading...';
            try {
                const res = await fetch(`${API_BASE}/api/metrics`);
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Metrics failed');
                renderMetrics(data);
            } catch (e) {
                el.textContent = `Error: ${e.message}`;
            }
        }

        function renderMetrics(metrics) {
            const el = document.getElementById('metrics');
            if (!metrics) { el.textContent = 'No metrics yet.'; return; }
            const rewards = metrics.episode_rewards || [];
            const lengths = metrics.episode_lengths || [];
            const mov = metrics.moving_avg_rewards || [];
            const eps = metrics.epsilon_history || [];
            el.innerHTML = `
                <div><strong>Total Episodes:</strong> ${rewards.length}</div>
                <div><strong>Last Reward:</strong> ${rewards.length ? rewards[rewards.length-1].toFixed(3) : '-'}</div>
                <div><strong>Last Length:</strong> ${lengths.length ? lengths[lengths.length-1] : '-'}</div>
                <div><strong>Moving Avg(100):</strong> ${mov.length ? mov[mov.length-1].toFixed(3) : '-'}</div>
                <div><strong>Last Epsilon:</strong> ${eps.length ? eps[eps.length-1].toFixed(3) : '-'}</div>
            `;
        }
        async function fetchPipeline() {
            const el = document.getElementById('pipeline');
            el.textContent = 'Loading...';
            try {
                const res = await fetch(`${API_BASE}/api/pipeline`);
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Pipeline failed');
                el.innerHTML = `
                    <div><strong>Users:</strong> ${data.n_users}</div>
                    <div><strong>Items:</strong> ${data.n_items}</div>
                    <div><strong>Interactions:</strong> ${data.num_interactions}</div>
                    <div><strong>Sparsity:</strong> ${data.sparsity_percent.toFixed(2)}%</div>
                    <div><strong>Ratings:</strong> ${data.rating_count}</div>
                    <div><strong>Interaction Matrix:</strong> ${data.interaction_matrix_shape}</div>
                    <div><strong>Rating Matrix:</strong> ${data.rating_matrix_shape || 'N/A'}</div>
                    <div><strong>User Features:</strong> ${data.user_feature_shape}</div>
                    <div><strong>Item Features:</strong> ${data.item_feature_shape}</div>
                    <div><strong>State Dim:</strong> ${data.state_dim}</div>
                `;
            } catch (e) {
                el.textContent = `Error: ${e.message}`;
            }
        }

        async function recommendForUser() {
            const user_id = parseInt(document.getElementById('recUser').value, 10);
            const n_recommendations = parseInt(document.getElementById('recK').value, 10);
            const el = document.getElementById('recStatus');
            el.textContent = 'Requesting...';
            try {
                const res = await fetch(`${API_BASE}/api/recommend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id, n_recommendations })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Recommend failed');
                el.textContent = `Top-${n_recommendations} for user ${user_id}: [${(data.recommendations || []).join(', ')}]`;
            } catch (e) {
                el.textContent = `Error: ${e.message}`;
            }
        }
    </script>
</body>
</html>